var contactApp=angular.module("contactApp",["ngRoute","ngMessages"]),socket=io();contactApp.directive("pwCheck",[function(){return{require:"ngModel",link:function(a,b,c,d){var e="#"+c.pwCheck;console.log(e),console.log(b),b.on("keyup",function(){a.$apply(function(){var a=b.val()===$(e).val();d.$setValidity("pwmatch",a)})})}}}]),contactApp.config(function(a){a.when("/",{templateUrl:"views/login.html",controller:"loginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"signupCtrl"}).when("/chat/:userid",{templateUrl:"views/chat.html",controller:"chatCtrl"}).when("/edituser/:userid",{templateUrl:"views/edituser.html",controller:"edituserCtrl"}).otherwise({redirectTo:"/"})}),contactApp.controller("loginCtrl",["$scope","$http","$location","$window",function(a,b,c,d){console.log("login Ctrl log executed"),a.user={},a.isFormSubmit=!1,a.loggedIn=!1;var e=angular.fromJson(d.sessionStorage.getItem("chatDetails"));null!=e&&c.url("/chat/"+e._id),a.loginClick=function(){a.userForm.$valid?a.isFormSubmit=!1:a.isFormSubmit=!0,a.userForm.$valid&&b.post("/api/login",a.user).success(function(b){b.length>=1?c.url("/chat/"+b[0]._id):a.loginErr="Please check your username or password"}).error(function(a){console.log(a)})}}]),contactApp.controller("signupCtrl",["$scope","$http","$location","$routeParams",function(a,b,c,d){console.log("Signup Ctrl log executed"),a.register={},a.isFormSubmit=!1,a.loggedIn=!1,a.registerClick=function(){if(a.registerForm.$valid?a.isFormSubmit=!1:a.isFormSubmit=!0,a.registerForm.$valid){for(var d="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz",f=0;20>f;f++)d+=e.charAt(Math.floor(Math.random()*e.length));a.register.token=d,b.post("/api/createUser",a.register).success(function(b){console.log("Success >>>>"),a.register={},a.register=b,console.log(b),c.url("/chat/"+b._id)}).error(function(a){console.log(a)})}}}]),contactApp.controller("edituserCtrl",["$scope","$http","$location","$window","$routeParams",function(a,b,c,d,e){console.log("edit Ctrl log executed"),b.post("/api/getUserDetail",{userid:e.userid}).success(function(b){b.length>0&&(a.register=b[0],a.register.oldPassword=b[0].password,a.register.oldConfirmPassword=b[0].confpassword,a.register.password=a.register.confpassword="")}).error(function(a){console.log(a)}),a.updateInfo=function(){""==a.register.password&&""==a.register.confpassword&&(a.register.password=a.register.oldPassword,a.register.confpassword=a.register.oldConfirmPassword),b.put("/api/userDetailsUpdate/"+e.userid,a.register).success(function(b){console.log(b),c.url("chat/"+a.register._id),d.sessionStorage.removeItem("chatDetails")}).error(function(a){console.log(a)})},a.cancelClick=function(){c.url("chat/"+a.register._id)}}]),contactApp.controller("chatCtrl",["$scope","$http","$location","$routeParams","$window","$q",function(a,b,c,d,e,f){console.log("Chat Ctrl log executed"),a.userDetails={};var g=angular.fromJson(e.sessionStorage.getItem("chatDetails"));a.groupUsersMsgList=[],a.chatMessageList=[],a.chatuser={},a.visibleChatBtn=!0,a.chatDirectiveVisible=!0,a.tabsGroup=[],a.userClickForChatVisible=!0,a.selectedIndex,a.usersStatus=[],null==g?b.post("/api/getUserDetail",{userid:d.userid}).success(function(b){b.length>0&&(e.sessionStorage.setItem("chatDetails",JSON.stringify(b[0])),a.userDetails=b[0])}).error(function(a){console.log("user information getting failed "+a)}):a.userDetails=angular.fromJson(g),socket.on("userAvailable",function(b){-1==a.usersStatus.indexOf(b.username)&&(a.usersStatus.push(b.username),a.$apply())}),socket.on("groupUsersChat",function(b){a.userDetails.group==b.userGroup&&(a.groupUsersMsgList.push(angular.fromJson(b)),a.$apply())}),socket.on("individualUserChat",function(b){angular.forEach(a.groupUsers,function(c,d){b.userId==c._id&&(a.chatMessageList.push(angular.fromJson(b)),a.$apply())})}),a.userChatClick=function(b,c,d){var e={userFullname:a.userDetails.firstname+" "+a.userDetails.lastname,userInput:a.chatuser.input,userGroup:a.userDetails.group,userId:a.userDetails._id,toSenderId:b,toSenderName:c,toSenderFullname:d,username:a.userDetails.username};a.chatuser.input="",socket.emit("individualUserChat",e)},a.chatEnterClick=function(){var b={username:a.userDetails.firstname,userInput:a.chat.input,userGroup:a.userDetails.group};a.chat.input="",socket.emit("groupUsersChat",b)},a.userHasMessage=[],a.$watchCollection("chatMessageList",function(a,b){}),a.$watchCollection("usersStatus",function(b,c){socket.emit("userAvailable",a.userDetails)}),a.$watch("userDetails.group",function(c,d){"undefined"!=c&&null!=c&&b.get("/api/groupUsers/"+a.userDetails.group).success(function(b){b.length>0&&(a.groupUsers=b)}).error(function(a){console.log(a)})}),a.userClickForChat=function(b,c,d,e,f){var g=$.grep(a.tabsGroup,function(a){return a.username===d});g.length<=0&&(a.tabsGroup.push({_id:c,username:d,fullname:e,showButton:!0,status:"active"}),a.selectedIndex=f)},a.closeUserChatBox=function(b){-1!=a.tabsGroup.indexOf(b)&&a.tabsGroup.splice(a.tabsGroup.indexOf(b),1)},a.logoutClick=function(){e.sessionStorage.removeItem("chatDetails"),c.url("/login")},a.visibleChatClick=function(){a.chatContainerVisible=!0,a.visibleChatBtn=!1},a.closeChat=function(){a.chatContainerVisible=!1,a.visibleChatBtn=!0}}]),contactApp.directive("chatDirective",function(){return{restrict:"E",scope:!1,templateUrl:"views/chat-directive.html",link:function(a,b,c){}}}),contactApp.directive("tabs",function(){return{restrict:"E",transclude:!0,scope:{},controller:["$scope",function(a){var b=a.panes=[];a.select=function(a){angular.forEach(b,function(a){a.selected=!1}),a.selected=!0},this.addPane=function(c){0==b.length&&a.select(c),b.push(c)},a.removePane=function(c){var d=b.indexOf(c);b.splice(b.indexOf(c),1),a.$parent.tabsGroup.splice(d,1),b.length>=1&&a.select(b[b.length-1])}}],template:'<div class="tabbable"><ul class="nav nav-tabs"><li ng-repeat="pane in panes" ng-class="{active:pane.selected}"><a href="" class="userChatBoxPane" ng-click="select(pane)">{{pane.title}}</a> <a ng-click="removePane(pane)" class="closeUserChatBox glyphicon glyphicon-remove pull-right"></a></li></ul><div class="tab-content" ng-transclude></div></div>',replace:!0}}).directive("pane",function(){return{require:"^tabs",restrict:"E",transclude:!0,scope:{title:"@"},link:function(a,b,c,d){d.addPane(a)},template:'<div class="tab-pane" ng-class="{active: selected}" ng-transclude></div>',replace:!0}});